# Video Storage Strategy - Current State & Recommendations

## Current Implementation Status

### âŒ Videos Are NOT Automatically Saved to R2

**Currently:**
- Videos are generated by PiAPI
- PiAPI returns a temporary `video_url` and `video_raw_url`
- These URLs are stored directly in the database
- **No download to R2 occurs** - videos remain on PiAPI's servers

**Problem:** If PiAPI changes their URLs or deletes files, videos become inaccessible

---

## Image Workflow (Reference Pattern)

### âœ… Images Use "Save Draft" Pattern

**Generation:**
```python
# Generate preview (NOT saved to R2)
result = await image_generator.generate_image(
    prompt=prompt,
    save_to_r2=False,  # Preview mode
    ...
)
```

**UI Shows:**
- Preview image from provider URL
- **"Save Draft" button** - downloads and stores to R2

**Save Process:**
```javascript
// Frontend calls save-draft endpoint
await api.post("/api/images/save-draft", {
  image_url: image.image_url,
  campaign_id: campaignId,
  ...
});

// Backend downloads and saves to R2
result = await image_generator.save_draft_image(
    image_url=request.image_url,
    campaign_id=request.campaign_id,
    ...
)
```

---

## Recommended Video Implementation

### Option 1: Add "Save" Button (Recommended)

**Following the image pattern:**

1. **Generate Video (Preview Only)**
   - Same as current - PiAPI generates video
   - Returns `video_url` for preview
   - Status: `processing` â†’ `completed`

2. **UI Shows:**
   ```
   [View Video] [Download] [Save to Library]  â† NEW BUTTON
   ```

3. **When User Clicks "Save to Library":**
   ```bash
   POST /api/video/save-to-library
   {
     "video_id": 123,
     "campaign_id": 456
   }
   ```

4. **Backend Process:**
   - Download video from PiAPI URL
   - Upload to Cloudflare R2
   - Update database with R2 URL
   - Delete PiAPI URL (optional)

**Benefits:**
- âœ… Users control storage costs
- âœ… Preview videos don't use R2 storage
- âœ… Matches existing image workflow
- âœ… Users can choose which videos to keep

---

### Option 2: Auto-Save All Videos

**Changes:**
- Modify video generation to auto-download and save to R2
- Remove provider URLs from database
- All videos permanently stored in R2

**Drawbacks:**
- âŒ Higher R2 costs (storing all videos, even unused ones)
- âŒ More storage space needed
- âŒ Different from image workflow
- âŒ No way for users to preview before saving

**Not Recommended** - goes against the established pattern

---

## Implementation Plan

### Backend Changes Needed

1. **Add Save-to-Library Endpoint**
   ```python
   @router.post("/save-to-library", response_model=VideoSaveResponse)
   async def save_video_to_library(
       request: VideoSaveRequest,
       current_user: User = Depends(get_current_user),
       db: AsyncSession = Depends(get_db)
   ):
   ```

2. **Add R2 Storage Logic**
   ```python
   async def save_video_to_r2(video_url: str, campaign_id: int) -> str:
       # Download video from PiAPI
       async with httpx.AsyncClient() as client:
           response = await client.get(video_url)
           video_data = response.content

       # Upload to R2
       r2_key = f"campaigns/{campaign_id}/videos/{uuid.uuid4()}.mp4"
       _, r2_url = await r2_storage.upload_file(
           file_bytes=video_data,
           key=r2_key,
           content_type="video/mp4"
       )

       return r2_url
   ```

3. **Update Database**
   ```sql
   UPDATE video_generations
   SET video_url = 'R2_URL',
       video_raw_url = 'R2_URL',
       saved_to_r2 = TRUE
   WHERE id = :video_id
   ```

### Frontend Changes Needed

1. **Update Video Library UI**
   ```typescript
   // In video library page
   {video.status === "completed" && (
     <>
       <a href={video.video_url}>View Video</a>
       <a href={video.video_raw_url}>Download</a>
       {!video.saved_to_r2 && (
         <button onClick={() => handleSaveToLibrary(video.id)}>
           Save to Library
         </button>
       )}
       {video.saved_to_r2 && (
         <span>âœ“ Saved to Library</span>
       )}
     </>
   )}
   ```

2. **Add Save Handler**
   ```typescript
   async function handleSaveToLibrary(videoId: number) {
     try {
       await api.post("/api/video/save-to-library", { video_id: videoId });
       toast.success("Video saved to library!");
       refetchVideos();
     } catch (err) {
       toast.error("Failed to save video");
     }
   }
   ```

---

## Database Schema Update

Add new column to `video_generations` table:

```sql
ALTER TABLE video_generations
ADD COLUMN saved_to_r2 BOOLEAN DEFAULT FALSE,
ADD COLUMN r2_key VARCHAR(255);
```

---

## Storage Costs Analysis

### Current (No Auto-Save)
- **R2 Storage**: $0 (no videos stored)
- **R2 Bandwidth**: $0 (no downloads)
- **Total**: $0

### With Save Button
- **Users save 30% of videos** (estimated):
  - 7,000 videos/month Ã— 30% = 2,100 saved
  - Average video size: 10 MB
  - Total storage: 21 GB/month
  - R2 Storage cost: ~$0.42/month
  - R2 Bandwidth: ~$0.17/month
  - **Total**: ~$0.59/month

**Very reasonable cost!** ğŸ’°

---

## UX Flow

### Video Generation Flow
```
1. User generates video
   â†“
2. Video processes (PiAPI)
   â†“
3. Completed - shows in library
   â†“
4. User clicks "Save to Library" (optional)
   â†“
5. Video downloaded and stored in R2
   â†“
6. Video permanently available
```

### Video Library Display
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ–¼ï¸ [Thumbnail]                       â”‚
â”‚                                     â”‚
â”‚ Status: Completed                   â”‚
â”‚ Provider: Hunyuan                   â”‚
â”‚ Cost: $0.03                         â”‚
â”‚                                     â”‚
â”‚ [View] [Download] [Save] âœ“ Saved    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Recommendation

**Implement Option 1: Save Button Pattern**

**Reasons:**
1. âœ… Matches existing image workflow
2. âœ… Users control storage costs
3. âœ… Preview videos don't use R2
4. âœ… Simple implementation
5. âœ… Low storage costs (~$0.60/month for 2,100 saved videos)

**Next Steps:**
1. Add `/api/video/save-to-library` endpoint
2. Implement R2 download/upload logic
3. Update database schema
4. Add "Save to Library" button in frontend
5. Test the workflow

**Estimated Implementation Time:** 2-3 hours

---

## Alternative: Auto-Delete Unused Videos

**Additional Enhancement:**
After 30 days, auto-delete videos that were never saved:

```sql
DELETE FROM video_generations
WHERE saved_to_r2 = FALSE
  AND created_at < NOW() - INTERVAL '30 days'
```

**Benefits:**
- Keeps database clean
- No permanent storage of unused videos
- Users have 30 days to decide

**Optional but recommended!**
